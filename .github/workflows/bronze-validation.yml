name: Bronze Level Validation

on:
  push:
    branches:
      - main
  pull_request:
  workflow_call:

jobs:
  bronze-validation:
    name: Bronze Level Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy

      - name: Run Ruff Check (Linting)
        run: |
          ruff check custom_components/

      - name: Run Ruff Format (Code Formatting)
        run: |
          ruff format --check custom_components/

      - name: Run mypy (Type Checking)
        run: |
          mypy custom_components/intellicenter/ --ignore-missing-imports --no-strict-optional
        continue-on-error: true  # TODO: Enable strict checking once type coverage improves

      - name: Check for tests directory
        run: |
          if [ ! -d "tests" ]; then
            echo "⚠️  WARNING: No tests/ directory found - required for Bronze compliance"
            echo "⚠️  See BRONZE_COMPLIANCE.md for details"
            exit 1
          fi
        continue-on-error: true  # Warning only for now

      - name: Run pytest (if tests exist)
        run: |
          if [ -d "tests" ]; then
            pip install pytest pytest-homeassistant-custom-component
            pytest tests/ -v
          else
            echo "Skipping tests - no tests directory found"
          fi
        continue-on-error: true  # TODO: Make this required once tests are added

  hassfest:
    name: Validate with hassfest
    runs-on: ubuntu-latest
    needs: bronze-validation
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run hassfest
        uses: home-assistant/actions/hassfest@master

  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    needs: [bronze-validation, hassfest]
    if: |
      github.event_name == 'pull_request' &&
      (contains(github.event.pull_request.body, '@claude') || contains(github.event.pull_request.title, '@claude'))
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
