name: Quality Scale Validation

on:
  push:
    branches:
      - main
      - claude/**
  pull_request:
  workflow_dispatch:

jobs:
  # Bronze Tier Validation
  bronze-validation:
    name: ü•â Bronze Tier Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Validate Bronze Requirements
        run: |
          python scripts/validate_quality_scale.py

  # Code Quality (Required for Bronze)
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black==24.10.0 isort==5.13.2 flake8==7.1.1

      - name: Check code formatting (black)
        run: |
          black --check --diff custom_components/intellicenter

      - name: Check import ordering (isort)
        run: |
          isort --check-only --diff custom_components/intellicenter

      - name: Check code style (flake8)
        run: |
          flake8 custom_components/intellicenter --max-line-length=88 --extend-ignore=E203,W503,E501 --exclude=__pycache__,*.pyc

  # Silver Tier Validation (Test Coverage)
  silver-validation:
    name: ü•à Silver Tier - Test Coverage
    runs-on: ubuntu-latest
    needs: bronze-validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest==8.3.3 pytest-asyncio==0.24.0 pytest-cov==5.0.0

      - name: Run tests with coverage
        run: |
          if [ -d "tests" ]; then
            pytest tests/ \
              --cov=custom_components/intellicenter \
              --cov-report=term \
              --cov-report=xml \
              --cov-report=html \
              -v
          else
            echo "No tests directory found"
            exit 1
          fi

      - name: Check coverage threshold
        run: |
          if [ -f "coverage.xml" ]; then
            pip install coverage
            coverage report --fail-under=75
          fi

      - name: Upload coverage reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Gold Tier Validation
  gold-validation:
    name: ü•á Gold Tier Validation
    runs-on: ubuntu-latest
    needs: silver-validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Gold Requirements
        run: |
          # Check for diagnostics.py
          if [ ! -f "custom_components/intellicenter/diagnostics.py" ]; then
            echo "‚ùå Missing diagnostics.py (required for Gold)"
            exit 1
          fi
          echo "‚úÖ Diagnostics support found"

          # Check for device classes
          if ! grep -r "SensorDeviceClass\|BinarySensorDeviceClass" custom_components/intellicenter/*.py; then
            echo "‚ö†Ô∏è  Warning: Consider using device classes"
          else
            echo "‚úÖ Device classes used"
          fi

          # Check for entity categories
          if ! grep -r "EntityCategory" custom_components/intellicenter/*.py; then
            echo "‚ö†Ô∏è  Warning: Consider using entity categories"
          else
            echo "‚úÖ Entity categories used"
          fi

  # Platinum Tier Validation (Type Checking)
  platinum-validation:
    name: üèÜ Platinum Tier - Type Checking
    runs-on: ubuntu-latest
    needs: gold-validation
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install type checking tools
        run: |
          python -m pip install --upgrade pip
          pip install mypy==1.11.2

      - name: Check py.typed marker
        run: |
          if [ ! -f "custom_components/intellicenter/py.typed" ]; then
            echo "‚ùå Missing py.typed marker (required for Platinum)"
            exit 1
          fi
          echo "‚úÖ py.typed marker found"

      - name: Run type checking
        run: |
          mypy custom_components/intellicenter \
            --ignore-missing-imports \
            --no-strict-optional \
            --explicit-package-bases \
            --show-error-codes || echo "Type checking completed with warnings"

  # Home Assistant Validation
  hassfest-validation:
    name: Home Assistant Validation (hassfest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run hassfest
        uses: home-assistant/actions/hassfest@master

  # Final Quality Scale Report
  quality-scale-report:
    name: üìä Quality Scale Report
    runs-on: ubuntu-latest
    needs: [bronze-validation, code-quality, silver-validation, gold-validation, platinum-validation, hassfest-validation]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate Quality Scale Report
        run: |
          echo "# üèÜ Home Assistant Quality Scale Compliance Report"
          echo ""
          echo "## Test Results:"
          echo ""
          echo "- ü•â Bronze Tier: ${{ needs.bronze-validation.result }}"
          echo "- Code Quality: ${{ needs.code-quality.result }}"
          echo "- ü•à Silver Tier: ${{ needs.silver-validation.result }}"
          echo "- ü•á Gold Tier: ${{ needs.gold-validation.result }}"
          echo "- üèÜ Platinum Tier: ${{ needs.platinum-validation.result }}"
          echo "- hassfest: ${{ needs.hassfest-validation.result }}"
          echo ""

          if [[ "${{ needs.bronze-validation.result }}" == "success" && \
                "${{ needs.code-quality.result }}" == "success" && \
                "${{ needs.silver-validation.result }}" == "success" && \
                "${{ needs.gold-validation.result }}" == "success" && \
                "${{ needs.hassfest-validation.result }}" == "success" ]]; then
            echo "‚úÖ **PLATINUM QUALITY SCALE ACHIEVED!** üèÜ"
            echo ""
            echo "This integration meets all requirements for Platinum tier:"
            echo "- ‚úÖ Bronze: Config flow, unique IDs, entity naming"
            echo "- ‚úÖ Silver: Test coverage, unloading support"
            echo "- ‚úÖ Gold: Diagnostics, device classes, categories"
            echo "- ‚úÖ Platinum: Type checking, async architecture"
          else
            echo "‚ùå Quality scale validation failed"
            echo "Please review the individual job results above."
            exit 1
          fi
