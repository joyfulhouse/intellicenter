---
name: Claude Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  # Wait for quality validation to complete before running Claude Code review
  # This ensures Bronze and Silver validation pass before Claude reviews
  quality-validation:
    # Only run on pull request events, not push
    if: |
      github.event_name == 'pull_request_review_comment' ||
      github.event_name == 'pull_request_review' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    uses: ./.github/workflows/quality-validation.yml
    secrets: inherit

  claude:
    name: Claude Code Review
    needs: [quality-validation]
    # Only trigger Claude when explicitly mentioned with @claude
    # AND only on pull request contexts
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' &&
       contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Quality validation status
        run: |
          echo "=================================================="
          echo "âœ… Quality Validation Passed"
          echo "=================================================="
          echo ""
          echo "Bronze and Silver tier validation completed successfully."
          echo "Proceeding with Claude Code review..."
          echo ""

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            actions: read
